<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Neko Pong: èµ›åšçŒ«å¨˜å¤§ä½œæˆ˜</title>
    
    <meta name="theme-color" content="#0f172a" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS (ä½¿ç”¨CDNï¼Œè‹¥éœ€å®Œå…¨ç¦»çº¿å¯ä¸‹è½½æœ¬åœ°ï¼Œä½†CDNé€šå¸¸ç¨³å®š) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #0f172a;
        touch-action: none; /* ç¦æ­¢ç§»åŠ¨ç«¯é»˜è®¤è§¦æ‘¸è¡Œä¸º */
        user-select: none;
        -webkit-user-select: none;
        font-family: ui-sans-serif, system-ui, sans-serif;
        height: 100dvh;
        width: 100vw;
      }
      canvas { display: block; }
      .hidden { display: none !important; }
      
      /* æ‰«æçº¿æ•ˆæœ */
      .scanline {
        background: linear-gradient(
          to bottom,
          rgba(255,255,255,0),
          rgba(255,255,255,0) 50%,
          rgba(0,0,0,0.1) 50%,
          rgba(0,0,0,0.1)
        );
        background-size: 100% 4px;
        position: absolute;
        pointer-events: none;
        inset: 0;
        z-index: 5;
      }

      /* æ»‘åŠ¨æ¡æ ·å¼ */
      input[type=range] {
        -webkit-appearance: none; 
        background: transparent; 
      }
      input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        height: 20px; width: 20px;
        border-radius: 50%;
        background: #ec4899;
        cursor: pointer;
        margin-top: -8px; 
        box-shadow: 0 0 10px #ec4899;
      }
      input[type=range]::-webkit-slider-runnable-track {
        width: 100%; height: 4px;
        background: #334155;
        border-radius: 2px;
      }
      
      .animate-float { animation: float 3s ease-in-out infinite; }
      @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
      
      /* è¿”å›å¤§å…æŒ‰é’® */
      .hub-btn {
          position: absolute;
          top: 1rem;
          left: 1rem;
          z-index: 60;
          color: rgba(255,255,255,0.5);
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
          cursor: pointer;
          transition: all 0.2s;
          text-decoration: none;
          background: rgba(15, 23, 42, 0.6);
          border: 1px solid rgba(255,255,255,0.1);
          padding: 8px 16px;
          border-radius: 4px;
          font-size: 12px;
          backdrop-filter: blur(4px);
          font-weight: bold;
          letter-spacing: 1px;
      }
      .hub-btn:hover { 
          color: #fff; 
          background: rgba(15, 23, 42, 0.9);
          border-color: rgba(236, 72, 153, 0.5); /* Pink border on hover */
          box-shadow: 0 0 10px rgba(236, 72, 153, 0.2);
      }
    </style>
</head>
<body class="text-white relative h-full w-full overflow-hidden">

    <a href="index.html" class="hub-btn">â† é€€å‡ºæ¸¸æˆ</a>

    <!-- æ¸¸æˆ UI å±‚ -->
    <div id="ui-layer" class="absolute inset-0 pointer-events-none z-10 flex flex-col justify-between p-4">
        
        <!-- é¡¶éƒ¨ HUD -->
        <div class="flex justify-between items-start w-full">
            <!-- ç©å®¶ä¿¡æ¯ -->
            <div class="text-cyan-400 font-bold text-xl md:text-2xl drop-shadow-[0_0_10px_rgba(34,211,238,0.5)] flex flex-col ml-8">
                <span>ç©å®¶</span>
                <span class="text-xs text-slate-500 font-normal tracking-widest">HUMAN</span>
            </div>

            <!-- æ¯”åˆ†æ¿ -->
            <div class="absolute left-1/2 -translate-x-1/2 top-4 flex gap-6 text-6xl md:text-8xl font-black italic tracking-tighter">
                <span id="score-player" class="text-cyan-400 drop-shadow-[0_0_20px_rgba(34,211,238,0.6)]">0</span>
                <span class="text-slate-700">-</span>
                <span id="score-ai" class="text-pink-500 drop-shadow-[0_0_20px_rgba(236,72,153,0.6)]">0</span>
            </div>

            <!-- AI ä¿¡æ¯ & é€€å‡ºæŒ‰é’® -->
            <div class="flex flex-col items-end gap-2 pointer-events-auto">
                <div class="text-pink-500 font-bold text-xl md:text-2xl drop-shadow-[0_0_10px_rgba(236,72,153,0.5)] text-right">
                    çŒ«å¨˜ AI
                    <div id="badge-difficulty" class="text-xs text-pink-300 font-normal opacity-80 tracking-widest">æ™®é€šæ¨¡å¼</div>
                </div>
                <button id="btn-exit" class="hidden px-4 py-1 bg-slate-800/80 hover:bg-slate-700 text-slate-400 border border-slate-600 rounded-full text-xs font-bold uppercase backdrop-blur transition">
                    é€€å‡º (ESC)
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨ å˜²è®½æ°”æ³¡ -->
        <div id="chat-bubble" class="self-center mb-4 w-[90%] max-w-md transition-all duration-300 transform translate-y-4 opacity-0">
            <div class="bg-slate-900/90 border border-pink-500/30 rounded-2xl p-4 shadow-2xl backdrop-blur flex items-center gap-4">
                <div class="text-4xl animate-bounce">ğŸ±</div>
                <div class="flex-1">
                    <div class="text-pink-500 text-[10px] font-bold uppercase tracking-wider mb-1">ç³»ç»Ÿæ¶ˆæ¯</div>
                    <p id="chat-text" class="text-sm md:text-base font-medium text-white/90">ç³»ç»Ÿå¯åŠ¨ä¸­...å–µï¼</p>
                </div>
            </div>
        </div>
    </div>

    <!-- èœå•ç•Œé¢ -->
    <div id="menu-screen" class="absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/90 backdrop-blur-md transition-opacity duration-300">
        <div class="text-center mb-12 animate-float">
            <h1 class="text-7xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-br from-cyan-400 via-violet-500 to-pink-500 italic tracking-tighter drop-shadow-2xl">
                çŒ«å¨˜<br>å¤§ä½œæˆ˜
            </h1>
            <p class="text-pink-500 font-mono text-sm tracking-[0.5em] mt-2">NEKO PONG</p>
        </div>

        <div class="flex flex-col gap-4 w-64 md:w-80 pointer-events-auto">
            <button id="btn-start" class="w-full py-4 bg-gradient-to-r from-pink-600 to-pink-500 hover:from-pink-500 hover:to-pink-400 text-white rounded-xl font-bold text-xl tracking-widest shadow-[0_0_20px_rgba(236,72,153,0.4)] transition hover:scale-105 active:scale-95">
                å¼€å§‹å¯¹æˆ˜
            </button>
            <button id="btn-settings" class="w-full py-3 bg-slate-800 hover:bg-slate-700 text-cyan-400 border border-cyan-500/30 rounded-xl font-bold tracking-widest transition hover:scale-105 active:scale-95">
                æ¸¸æˆè®¾ç½®
            </button>
        </div>
        
        <p class="mt-8 text-slate-500 text-xs font-mono">é¼ æ ‡æ§åˆ¶çƒæ‹ â€¢ ESC é€€å‡º â€¢ ç‡å…ˆè·å¾—5åˆ†èƒœåˆ©</p>
    </div>

    <!-- è®¾ç½®ç•Œé¢ -->
    <div id="settings-screen" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-950/95 backdrop-blur-xl">
        <h2 class="text-3xl font-bold text-white mb-10 tracking-wider">ç³»ç»Ÿè®¾ç½®</h2>
        
        <div class="w-72 space-y-6">
            <!-- éš¾åº¦ -->
            <div class="space-y-2">
                <div class="flex justify-between text-pink-400 font-bold text-sm">
                    <span>AI å¼ºåº¦</span>
                    <span id="val-difficulty">æ™®é€š</span>
                </div>
                <input type="range" id="input-difficulty" min="0" max="3" step="1" value="1" class="w-full">
                <div class="flex justify-between text-[10px] text-slate-600 font-mono">
                    <span>å‘†èŒ</span><span>æ™®é€š</span><span>å›°éš¾</span><span>çŒ«ç¥</span>
                </div>
            </div>

            <!-- é€Ÿåº¦ -->
            <div class="space-y-2">
                <div class="flex justify-between text-cyan-400 font-bold text-sm">
                    <span>çƒé€Ÿå€ç‡</span>
                    <span id="val-speed">x1.0</span>
                </div>
                <input type="range" id="input-speed" min="0.8" max="2.0" step="0.2" value="1.0" class="w-full">
            </div>

            <!-- å…¨å± -->
            <div class="flex items-center justify-between p-3 bg-slate-900 rounded-lg border border-slate-800">
                <span class="text-slate-300 text-sm font-bold">å…¨å±æ¨¡å¼</span>
                <button id="btn-fullscreen" class="bg-slate-700 px-3 py-1 rounded text-xs hover:bg-slate-600 transition">åˆ‡æ¢</button>
            </div>
        </div>

        <button id="btn-save" class="mt-12 px-10 py-3 bg-white text-slate-950 font-black rounded-full shadow-xl hover:bg-slate-200 transition hover:scale-105 tracking-widest">
            ä¿å­˜å¹¶è¿”å›
        </button>
    </div>

    <!-- ç»“ç®—ç•Œé¢ -->
    <div id="result-screen" class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center bg-slate-900/95 backdrop-blur-md">
        <h2 id="result-title" class="text-6xl md:text-8xl font-black mb-4 italic tracking-tighter">èƒœåˆ©!</h2>
        <p id="result-score" class="text-2xl text-slate-300 font-mono mb-10">æœ€ç»ˆæ¯”åˆ†: 5 - 3</p>
        <div class="flex gap-4">
            <button id="btn-retry" class="px-8 py-3 bg-pink-500 hover:bg-pink-400 text-white rounded-lg font-bold shadow-lg transition hover:scale-105">
                å†æ¥ä¸€å±€
            </button>
            <button id="btn-home" class="px-8 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-bold shadow-lg transition hover:scale-105">
                è¿”å›èœå•
            </button>
        </div>
    </div>

    <!-- æ¸¸æˆç”»å¸ƒ -->
    <canvas id="gameCanvas" class="block w-full h-full cursor-none"></canvas>
    <div class="scanline"></div>

    <!-- æ ¸å¿ƒé€»è¾‘è„šæœ¬ -->
    <script>
        /**
         * æ¸¸æˆå¸¸é‡é…ç½®
         */
        const CONFIG = {
            PADDLE_H_RATIO: 0.15, 
            PADDLE_W_RATIO: 0.015,
            MARGIN: 15,
            BALL_RADIUS: 8,
            WIN_SCORE: 5,
            BASE_SPEED: 6
        };

        /**
         * çŠ¶æ€ç®¡ç†
         */
        const state = {
            status: 'MENU',
            w: 0, h: 0,
            scores: { player: 0, ai: 0 },
            ball: { x: 0, y: 0, dx: 0, dy: 0, speed: 0 },
            paddles: { pY: 0, aiY: 0, targetPY: 0 },
            input: { virtualY: 0 },
            particles: [],
            countdown: 0,
            settings: {
                difficulty: 1, 
                speedMulti: 1.0,
                diffName: "æ™®é€š"
            },
            ai: {
                lerp: 0.08,
                error: 0,
                predictY: 0
            }
        };

        // çº¯æœ¬åœ°å†…ç½®è¯åº“ (ä¸°å¯Œäº†ä¸€äº›)
        const DIALOGS = {
            start: [
                "æ‚é±¼~ æ‚é±¼~ å‡†å¤‡å¥½å“­äº†å—ï¼Ÿâ™¡", 
                "è¿™ç§ç¨‹åº¦çš„æ‚é±¼ä¹Ÿæ•¢æ¥æŒ‘æˆ˜ï¼Ÿ", 
                "æˆ‘ä¼šæŠŠä½ è™åˆ°å“­ç€æ‰¾å¦ˆå¦ˆçš„å–µ~â™¡",
                "ä¸ä¼šå§ä¸ä¼šå§ï¼ŒçœŸæœ‰äººè§‰å¾—èƒ½èµ¢æˆ‘ï¼Ÿ",
                "è®©æˆ‘çœ‹çœ‹ä½ çš„æœ¬äº‹å§ï¼Œæ‚é±¼â™¡"
            ],
            pScore: [
                "åˆ‡... è¿æ°”å¥½è€Œå·²ï¼", 
                "åˆ«å¾—æ„å¿˜å½¢äº†ï¼Œæ­»æ‚é±¼ï¼", 
                "åˆšæ‰æ˜¯æˆ‘å¤§æ„äº†... å“¼ï¼",
                "ä½ ä½œå¼Šäº†å§ï¼ä¸€å®šæ˜¯ï¼",
                "è¿™çƒä¸ç®—ï¼å–µå‘œï¼"
            ],
            aiScore: [
                "æ‚é±¼~ æ‚é±¼~â™¡", 
                "å¥½å¼±å“~ ä½ çš„æ‰‹æ˜¯è£…é¥°å“å—ï¼Ÿ", 
                "è¿™å°±è¡Œäº†å—ï¼ŸçœŸæ²¡ç”¨å‘¢â™¡",
                "çœ‹æ¥ä½ åªæœ‰è¿™ç§ç¨‹åº¦äº†å–µ~", 
                "å†åŠªåŠ›ä¸€ç‚¹å•Šï¼Œæ‚é±¼å“¥å“¥~â™¡",
                "ç®€å•åˆ°æ— èŠå‘¢~ å–µ~"
            ],
            aiHit: [
                "å¤ªæ…¢äº†ï¼", 
                "ç»™æˆ‘æ¥å¥½ï¼", 
                "è¥¿å†…ï¼", 
                "è´«å¼±è´«å¼±ï¼", 
                "æœ¨å¤§æœ¨å¤§ï¼",
                "çœ‹æ‹›ï¼"
            ]
        };

        // DOM å…ƒç´ 
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d', { alpha: false });
        const ui = {
            pScore: document.getElementById('score-player'),
            aiScore: document.getElementById('score-ai'),
            chat: document.getElementById('chat-bubble'),
            chatText: document.getElementById('chat-text'),
            menu: document.getElementById('menu-screen'),
            settings: document.getElementById('settings-screen'),
            result: document.getElementById('result-screen'),
            resultTitle: document.getElementById('result-title'),
            resultScore: document.getElementById('result-score'),
            btnExit: document.getElementById('btn-exit'),
            diffBadge: document.getElementById('badge-difficulty')
        };

        /**
         * åˆå§‹åŒ–
         */
        function init() {
            resize();
            window.addEventListener('resize', resize);
            
            // ç»‘å®šæŒ‰é’®äº‹ä»¶
            document.getElementById('btn-start').onclick = startGame;
            document.getElementById('btn-settings').onclick = openSettings;
            document.getElementById('btn-save').onclick = closeSettings;
            document.getElementById('btn-exit').onclick = goHome;
            document.getElementById('btn-retry').onclick = startGame;
            document.getElementById('btn-home').onclick = goHome;
            document.getElementById('btn-fullscreen').onclick = toggleFS;

            // è®¾ç½®ç›¸å…³ç»‘å®š
            document.getElementById('input-difficulty').oninput = (e) => {
                const val = parseInt(e.target.value);
                const names = ["å‘†èŒ", "æ™®é€š", "å›°éš¾", "çŒ«ç¥"];
                state.settings.difficulty = val;
                state.settings.diffName = names[val];
                document.getElementById('val-difficulty').innerText = names[val];
                
                const speeds = [0.05, 0.08, 0.15, 0.35];
                state.ai.lerp = speeds[val];
            };

            document.getElementById('input-speed').oninput = (e) => {
                const val = parseFloat(e.target.value);
                state.settings.speedMulti = val;
                document.getElementById('val-speed').innerText = `x${val.toFixed(1)}`;
            };
            
            // é¼ æ ‡/è§¦æ‘¸æ§åˆ¶
            document.addEventListener('mousemove', (e) => {
                if (state.status !== 'PLAYING' || state.countdown > 0) return;

                if (document.pointerLockElement === canvas) {
                    state.input.virtualY += e.movementY;
                } else {
                    state.input.virtualY = e.clientY;
                }
                state.input.virtualY = Math.max(0, Math.min(state.h, state.input.virtualY));

                const ph = state.h * CONFIG.PADDLE_H_RATIO;
                state.paddles.targetPY = Math.max(0, Math.min(state.h - ph, state.input.virtualY - ph/2));
            });

            document.addEventListener('touchmove', (e) => {
                if (state.status !== 'PLAYING' || state.countdown > 0) return;
                e.preventDefault();
                const y = e.touches[0].clientY;
                state.input.virtualY = y;
                const ph = state.h * CONFIG.PADDLE_H_RATIO;
                state.paddles.targetPY = Math.max(0, Math.min(state.h - ph, y - ph/2));
            }, { passive: false });

            // ESC é€€å‡º
            document.addEventListener('pointerlockchange', () => {
                if (document.pointerLockElement !== canvas && state.status === 'PLAYING') {
                    goHome();
                }
            });

            requestAnimationFrame(loop);
            showChat("ç³»ç»Ÿå°±ç»ªï¼Œç­‰å¾…æŒ‡ä»¤å–µ~");
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            state.w = canvas.width;
            state.h = canvas.height;
            const ph = state.h * CONFIG.PADDLE_H_RATIO;
            if (state.status === 'MENU') {
                state.paddles.pY = (state.h - ph) / 2;
                state.paddles.aiY = (state.h - ph) / 2;
                state.input.virtualY = state.h / 2;
            }
        }

        // --- æ¸¸æˆæµç¨‹ ---
        function startGame() {
            state.status = 'PLAYING';
            state.scores = { player: 0, ai: 0 };
            state.particles = [];
            state.input.virtualY = state.h / 2;
            state.paddles.targetPY = (state.h - state.h * CONFIG.PADDLE_H_RATIO) / 2;
            state.paddles.pY = state.paddles.targetPY;

            ui.menu.classList.add('hidden');
            ui.result.classList.add('hidden');
            ui.settings.classList.add('hidden');
            ui.btnExit.classList.remove('hidden');
            
            ui.diffBadge.innerText = state.settings.diffName;
            updateScoreUI();
            
            canvas.requestPointerLock();
            
            triggerChat('start');
            resetBall(Math.random() > 0.5 ? 1 : -1);
        }

        function resetBall(direction) {
            state.countdown = 3;
            state.ball.speed = CONFIG.BASE_SPEED * state.settings.speedMulti;
            state.ball.dx = 0; state.ball.dy = 0;
            state.ball.y = state.h / 2;
            const pw = Math.max(10, state.w * CONFIG.PADDLE_W_RATIO);
            state.ball.x = direction === 1 ? CONFIG.MARGIN + pw + 20 : state.w - CONFIG.MARGIN - pw - 20;

            const timer = setInterval(() => {
                state.countdown--;
                if (state.countdown <= 0) {
                    clearInterval(timer);
                    launchBall(direction);
                }
            }, 1000);
        }

        function launchBall(direction) {
            const angle = (Math.random() * Math.PI / 2.5) - (Math.PI / 5);
            state.ball.dx = direction * state.ball.speed * Math.cos(angle);
            state.ball.dy = state.ball.speed * Math.sin(angle);
            state.ai.error = 0; 
        }

        function goHome() {
            state.status = 'MENU';
            ui.menu.classList.remove('hidden');
            ui.result.classList.add('hidden');
            ui.settings.classList.add('hidden');
            ui.btnExit.classList.add('hidden');
            if (document.pointerLockElement === canvas) document.exitPointerLock();
        }

        function openSettings() { ui.settings.classList.remove('hidden'); }
        function closeSettings() { ui.settings.classList.add('hidden'); }
        function toggleFS() {
            if (!document.fullscreenElement) document.documentElement.requestFullscreen().catch(e=>{});
            else document.exitFullscreen().catch(e=>{});
        }

        // --- æ ¸å¿ƒæ›´æ–° ---
        function update() {
            if (state.status !== 'PLAYING') return;

            const ph = state.h * CONFIG.PADDLE_H_RATIO;
            const pw = Math.max(10, state.w * CONFIG.PADDLE_W_RATIO);

            // ç©å®¶ç§»åŠ¨
            state.paddles.pY += (state.paddles.targetPY - state.paddles.pY) * 0.2;

            // AI é€»è¾‘
            let aiTarget = state.paddles.aiY;
            if (state.countdown > 0) {
                aiTarget = (state.h - ph) / 2;
            } else if (state.ball.dx > 0) { 
                let targetY = state.ball.y;
                if (Math.random() < 0.02) { 
                    const errScale = (3 - state.settings.difficulty) * 30; 
                    state.ai.error = (Math.random() - 0.5) * errScale;
                }
                aiTarget = targetY + state.ai.error - ph/2;
            } else {
                aiTarget = (state.h - ph) / 2;
            }
            aiTarget = Math.max(0, Math.min(state.h - ph, aiTarget));
            state.paddles.aiY += (aiTarget - state.paddles.aiY) * state.ai.lerp;

            if (state.countdown > 0) return; 

            // çƒç‰©ç†
            state.ball.x += state.ball.dx;
            state.ball.y += state.ball.dy;

            if (state.ball.y < CONFIG.BALL_RADIUS || state.ball.y > state.h - CONFIG.BALL_RADIUS) {
                state.ball.dy *= -1;
                state.ball.y = state.ball.y < CONFIG.BALL_RADIUS ? CONFIG.BALL_RADIUS : state.h - CONFIG.BALL_RADIUS;
                spawnParticles(state.ball.x, state.ball.y, '#fff');
            }

            // ç¢°æ’
            if (state.ball.dx < 0 && state.ball.x - CONFIG.BALL_RADIUS < CONFIG.MARGIN + pw) {
                if (state.ball.y + CONFIG.BALL_RADIUS > state.paddles.pY && 
                    state.ball.y - CONFIG.BALL_RADIUS < state.paddles.pY + ph) {
                    hitBall(state.paddles.pY, 1, ph);
                    spawnParticles(state.ball.x, state.ball.y, '#22d3ee'); 
                }
            }
            if (state.ball.dx > 0 && state.ball.x + CONFIG.BALL_RADIUS > state.w - CONFIG.MARGIN - pw) {
                if (state.ball.y + CONFIG.BALL_RADIUS > state.paddles.aiY && 
                    state.ball.y - CONFIG.BALL_RADIUS < state.paddles.aiY + ph) {
                    hitBall(state.paddles.aiY, -1, ph);
                    spawnParticles(state.ball.x, state.ball.y, '#e879f9'); 
                    if (Math.random() < 0.3) triggerChat('aiHit');
                }
            }

            // å¾—åˆ†
            if (state.ball.x < -20) handleScore('ai');
            if (state.ball.x > state.w + 20) handleScore('player');

            updateParticles();
        }

        function hitBall(paddleY, direction, ph) {
            const center = paddleY + ph / 2;
            const dist = (state.ball.y - center) / (ph / 2); 
            const angle = dist * (Math.PI / 3); 
            const maxSpeed = CONFIG.BASE_SPEED * state.settings.speedMulti * 2.5;
            state.ball.speed = Math.min(state.ball.speed * 1.05, maxSpeed);
            state.ball.dx = direction * state.ball.speed * Math.cos(angle);
            state.ball.dy = state.ball.speed * Math.sin(angle);
        }

        function handleScore(winner) {
            if (winner === 'player') {
                state.scores.player++;
                triggerChat('pScore');
            } else {
                state.scores.ai++;
                triggerChat('aiScore');
            }
            updateScoreUI();
            if (state.scores.player >= CONFIG.WIN_SCORE || state.scores.ai >= CONFIG.WIN_SCORE) {
                endGame(winner);
            } else {
                resetBall(winner === 'player' ? 1 : -1); 
            }
        }

        function endGame(winner) {
            state.status = 'END';
            ui.btnExit.classList.add('hidden');
            ui.result.classList.remove('hidden');
            document.exitPointerLock(); 
            const isWin = winner === 'player';
            ui.resultTitle.innerText = isWin ? "ä½ èµ¢äº†!" : "æ‚é±¼~è¾“äº†â™¡";
            ui.resultTitle.className = isWin ? "text-6xl md:text-8xl font-black mb-4 italic tracking-tighter text-cyan-400" : "text-6xl md:text-8xl font-black mb-4 italic tracking-tighter text-pink-500";
            ui.resultScore.innerText = `æœ€ç»ˆæ¯”åˆ†: ${state.scores.player} - ${state.scores.ai}`;
        }

        function spawnParticles(x, y, color) {
            for(let i=0; i<10; i++) {
                state.particles.push({
                    x, y, vx: (Math.random() - 0.5) * 10, vy: (Math.random() - 0.5) * 10,
                    life: 1.0, color: color
                });
            }
        }

        function updateParticles() {
            for (let i = state.particles.length - 1; i >= 0; i--) {
                let p = state.particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.04;
                if (p.life <= 0) state.particles.splice(i, 1);
            }
        }

        // --- çº¯æœ¬åœ°å¯¹è¯ç³»ç»Ÿ (æ— ä»»ä½• Key) ---
        function triggerChat(event) {
            let text = "";
            if (DIALOGS[event]) {
                const arr = DIALOGS[event];
                text = arr[Math.floor(Math.random() * arr.length)];
            } else {
                text = "å–µï¼Ÿ";
            }
            showChatBubble(text);
        }

        function showChatBubble(text) {
            ui.chatText.innerText = text;
            ui.chat.style.opacity = '1';
            ui.chat.style.transform = 'translateY(0)';
            
            if (state.chatTimer) clearTimeout(state.chatTimer);
            state.chatTimer = setTimeout(() => {
                ui.chat.style.opacity = '0';
                ui.chat.style.transform = 'translateY(16px)';
            }, 3000);
        }

        function updateScoreUI() {
            ui.pScore.innerText = state.scores.player;
            ui.aiScore.innerText = state.scores.ai;
        }

        function draw() {
            ctx.fillStyle = '#0f172a';
            ctx.fillRect(0, 0, state.w, state.h);

            const ph = state.h * CONFIG.PADDLE_H_RATIO;
            const pw = Math.max(10, state.w * CONFIG.PADDLE_W_RATIO);

            // ä¸­çº¿
            ctx.beginPath();
            ctx.setLineDash([10, 15]);
            ctx.moveTo(state.w / 2, 0); ctx.lineTo(state.w / 2, state.h);
            ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 4; ctx.stroke(); ctx.setLineDash([]);

            // è¾…åŠ©çº¿
            if (state.status === 'PLAYING') {
                const cursorY = state.input.virtualY;
                ctx.beginPath();
                ctx.moveTo(0, cursorY); ctx.lineTo(state.w, cursorY);
                ctx.strokeStyle = 'rgba(34, 211, 238, 0.1)'; ctx.lineWidth = 1; ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(CONFIG.MARGIN + pw + 10, cursorY); ctx.lineTo(CONFIG.MARGIN + pw + 25, cursorY);
                ctx.strokeStyle = '#22d3ee'; ctx.lineWidth = 2; ctx.stroke();
            }

            // çƒæ‹
            ctx.fillStyle = '#22d3ee'; ctx.shadowBlur = 20; ctx.shadowColor = 'rgba(34,211,238,0.4)';
            roundRect(ctx, CONFIG.MARGIN, state.paddles.pY, pw, ph, 4); ctx.fill();

            ctx.fillStyle = '#e879f9'; ctx.shadowBlur = 20; ctx.shadowColor = 'rgba(232,121,249,0.4)';
            roundRect(ctx, state.w - CONFIG.MARGIN - pw, state.paddles.aiY, pw, ph, 4); ctx.fill();
            ctx.shadowBlur = 0;

            // çƒ
            if (state.status === 'PLAYING' || state.countdown > 0) {
                ctx.beginPath(); ctx.arc(state.ball.x, state.ball.y, CONFIG.BALL_RADIUS, 0, Math.PI * 2);
                ctx.fillStyle = '#fff'; ctx.fill();
            }

            // ç²’å­
            state.particles.forEach(p => {
                ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, 3, 0, Math.PI * 2); ctx.fill();
            });
            ctx.globalAlpha = 1.0;

            // å€’è®¡æ—¶
            if (state.countdown > 0 && state.status === 'PLAYING') {
                ctx.fillStyle = '#fff'; ctx.font = 'bold 120px sans-serif';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(state.countdown, state.w/2, state.h/2);
            }
        }

        function roundRect(ctx, x, y, w, h, r) {
            ctx.beginPath(); ctx.moveTo(x + r, y); ctx.lineTo(x + w - r, y);
            ctx.quadraticCurveTo(x + w, y, x + w, y + r); ctx.lineTo(x + w, y + h - r);
            ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h); ctx.lineTo(x + r, y + h);
            ctx.quadraticCurveTo(x, y + h, x, y + h - r); ctx.lineTo(x, y + r);
            ctx.quadraticCurveTo(x, y, x + r, y); ctx.closePath();
        }

        function loop() { update(); draw(); requestAnimationFrame(loop); }
        init();

    </script>
</body>
</html>