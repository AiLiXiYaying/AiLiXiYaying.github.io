<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¸–ç•Œ 02: çŒ«çŒ«ä¾¿åˆ©åº—</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&family=Nunito:wght@700&display=swap" rel="stylesheet">
    <style>
        body { 
            background-color: #fce7f3; 
            font-family: 'Nunito', 'PingFang SC', sans-serif;
            color: #831843;
            overflow: hidden;
            touch-action: manipulation;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 8px 32px rgba(255, 154, 162, 0.2);
        }

        /* æ‰¾é›¶åŠ¨ç”»é’ç¥¨ */
        .cash-fly { animation: flyIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes flyIn { from { transform: translateY(100px) rotate(10deg); opacity: 0; } to { transform: translateY(0) rotate(-3deg); opacity: 1; } }

        /* å•†å“æ‰«æçº¿ */
        .scan-line {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: #ef4444; box-shadow: 0 0 10px #ef4444;
            opacity: 0;
            z-index: 10;
        }
        .scanning .scan-line { animation: scan 0.3s linear; }
        @keyframes scan { 0% { top: 0; opacity: 1; } 100% { top: 100%; opacity: 0; } }

        .numpad-btn {
            background: white; border-bottom: 4px solid #fbcfe8;
            color: #831843; border-radius: 12px; font-size: 1.5rem;
            transition: all 0.1s;
        }
        .numpad-btn:active { transform: translateY(4px); border-bottom-width: 0; }
        
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }

        /* ç—›è‹¦åŠ æ³•è®¡æ•°å™¨ */
        .pain-counter {
            position: absolute; top: 10px; right: 10px;
            background: rgba(255,255,255,0.9);
            padding: 4px 12px; border-radius: 20px;
            font-weight: bold; font-size: 0.8rem;
            color: #db2777; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center relative bg-gradient-to-br from-pink-100 to-purple-200">

    <a href="index.html" class="absolute top-4 left-4 z-50 px-4 py-2 bg-white/80 rounded-full text-pink-600 font-bold shadow-sm hover:bg-white transition text-sm">
        â† è¿”å›å¤§å…
    </a>

    <!-- æ¸¸æˆä¸»å®¹å™¨ -->
    <div class="relative z-10 w-full max-w-5xl h-full md:h-[90vh] flex flex-col md:flex-row gap-4 p-4">
        
        <!-- å·¦ä¾§ï¼šæŸœå°åœºæ™¯ -->
        <div class="flex-1 flex flex-col gap-4 relative">
            <!-- é¡¾å®¢æ°”æ³¡ -->
            <div class="glass-panel p-4 rounded-3xl flex items-center gap-4 min-h-[100px] animate-bounce-slow relative overflow-hidden">
                <div class="text-5xl z-10">ğŸ±</div>
                <div class="z-10 relative">
                    <h3 id="customer-name" class="font-bold text-pink-800 text-sm uppercase tracking-wider mb-1">Customer</h3>
                    <p id="customer-msg" class="text-slate-700 font-bold text-lg leading-tight">...</p>
                </div>
                <!-- è£…é¥°èƒŒæ™¯ -->
                <div class="absolute right-0 top-0 w-32 h-32 bg-pink-200/50 rounded-full blur-2xl -translate-y-1/2 translate-x-1/4"></div>
            </div>

            <!-- æŸœå°æ¡Œé¢ä¸Š -->
            <div class="flex-1 glass-panel rounded-3xl p-4 relative flex flex-col overflow-hidden">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[10px] text-pink-400 font-bold uppercase tracking-widest">SCANNING AREA</div>
                    <div id="pain-counter" class="hidden text-xs bg-pink-100 text-pink-600 px-3 py-1 rounded-full font-bold">0 / 0</div>
                </div>
                
                <!-- å•†å“åŒºåŸŸ -->
                <div id="items-area" class="flex-1 flex flex-wrap content-start justify-center gap-4 p-4 overflow-y-auto align-content-start">
                    <!-- Items Injected Here -->
                </div>

                <!-- ç°é‡‘æ”¯ä»˜åŒºåŸŸ (æ‰¾é›¶å…³å¡æ˜¾ç¤º) -->
                <div id="cash-area" class="hidden absolute bottom-0 left-0 w-full bg-slate-900/5 backdrop-blur-sm p-4 flex justify-center items-center gap-4 border-t border-white/50 z-20">
                    <div class="text-sm text-slate-600 font-bold mr-2">é¡¾å®¢æ”¯ä»˜:</div>
                    <div id="cash-display" class="bg-green-100 border-2 border-green-500 text-green-700 px-6 py-2 rounded-lg font-mono text-xl font-bold shadow-lg transform -rotate-3 origin-center">
                        $0
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šæ”¶é“¶æœº -->
        <div class="w-full md:w-[400px] flex flex-col gap-4">
            
            <!-- æ”¶æ®æ¡ (è§†è§‰) -->
            <div class="bg-white mx-4 -mb-2 pt-4 pb-2 px-4 rounded-t-lg shadow-sm border-x border-t border-slate-200 text-xs font-mono text-slate-500 relative z-0">
                <div class="flex justify-between border-b border-dashed border-slate-300 pb-1 mb-1">
                    <span>NEKO MART</span>
                    <span id="receipt-id">#001</span>
                </div>
                <div id="receipt-list" class="max-h-24 overflow-y-auto space-y-1">
                    <!-- Receipt items -->
                </div>
                <div class="border-t border-dashed border-slate-300 pt-1 mt-1 flex justify-between font-bold text-slate-800">
                    <span>TOTAL</span>
                    <span id="receipt-total">$0</span>
                </div>
            </div>

            <!-- æœºå™¨ä¸»ä½“ -->
            <div class="bg-pink-600 rounded-3xl p-6 shadow-2xl relative z-10 flex-1 flex flex-col border-b-8 border-pink-800">
                
                <!-- å±å¹• -->
                <div class="bg-slate-800 p-2 rounded-xl mb-4 shadow-inner">
                    <div id="screen-container" class="bg-[#d1fae5] h-20 rounded-lg flex flex-col justify-center px-4 font-mono text-right overflow-hidden relative">
                        <div id="screen-sub" class="text-xs text-emerald-600/70 h-4 truncate">Ready...</div>
                        <div id="screen-main" class="text-3xl font-bold text-emerald-900 truncate">0</div>
                    </div>
                </div>

                <!-- æ§åˆ¶åŒºï¼šæ‰«ææ¨¡å¼ -->
                <div id="mode-scan" class="flex-1 flex flex-col gap-3">
                    <div class="text-white/80 text-xs text-center flex items-center justify-center gap-2">
                        <span>ç‚¹å‡»å•†å“</span> <span class="opacity-50">|</span> <span>åŠ æ³•ç´¯ç§¯</span>
                    </div>
                    <button onclick="triggerScan()" class="flex-1 bg-white text-pink-600 rounded-2xl font-black text-2xl shadow-[0_4px_0_#cbd5e1] active:shadow-none active:translate-y-[4px] transition-all flex items-center justify-center gap-2 group">
                        <span class="group-hover:scale-110 transition-transform">âš¡</span> æ‰«æ
                    </button>
                    <button id="btn-total" onclick="finishScanning()" disabled class="py-4 bg-emerald-500 text-white rounded-2xl font-bold text-xl shadow-[0_4px_0_#047857] active:shadow-none active:translate-y-[4px] transition-all disabled:opacity-50 disabled:cursor-not-allowed disabled:shadow-none disabled:translate-y-1">
                        æ”¶æ¬¾
                    </button>
                </div>

                <!-- æ§åˆ¶åŒºï¼šæ‰¾é›¶æ¨¡å¼ -->
                <div id="mode-change" class="hidden flex-1 flex flex-col gap-2">
                    <div class="flex justify-between text-white text-xs px-2">
                        <span>æ€»ä»·: <b id="change-total" class="text-pink-200">$0</b></span>
                        <span>æ”¯ä»˜: <b id="change-paid" class="text-emerald-200">$0</b></span>
                    </div>
                    <div class="text-center text-white font-bold text-sm bg-pink-800/50 rounded py-1 mb-1 border border-pink-500/30">
                        æ‰¾é›¶ = æ”¯ä»˜ - æ€»ä»·
                    </div>
                    
                    <div class="grid grid-cols-3 gap-2 flex-1">
                        <button class="numpad-btn" onclick="inputNum(1)">1</button>
                        <button class="numpad-btn" onclick="inputNum(2)">2</button>
                        <button class="numpad-btn" onclick="inputNum(3)">3</button>
                        <button class="numpad-btn" onclick="inputNum(4)">4</button>
                        <button class="numpad-btn" onclick="inputNum(5)">5</button>
                        <button class="numpad-btn" onclick="inputNum(6)">6</button>
                        <button class="numpad-btn" onclick="inputNum(7)">7</button>
                        <button class="numpad-btn" onclick="inputNum(8)">8</button>
                        <button class="numpad-btn" onclick="inputNum(9)">9</button>
                        <button class="numpad-btn text-sm font-bold text-pink-600" onclick="inputNum('C')">CLR</button>
                        <button class="numpad-btn" onclick="inputNum(0)">0</button>
                        <button class="numpad-btn bg-emerald-400 text-emerald-900 border-emerald-600" onclick="submitChange()">OK</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- æˆåŠŸå¼¹çª— -->
    <div id="modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/60 hidden backdrop-blur-sm transition-opacity opacity-0">
        <div class="bg-white p-8 rounded-3xl max-w-sm text-center shadow-2xl transform scale-90 transition-all duration-300" id="modal-box">
            <div class="text-6xl mb-4 animate-bounce">âœ¨</div>
            <h2 class="text-2xl font-black text-slate-800 mb-2">äº¤æ˜“å®Œæˆ!</h2>
            <p id="modal-msg" class="text-slate-500 mb-6 text-sm font-medium">åŠ æ³•è®¡ç®—æ­£ç¡®ï¼</p>
            <button onclick="nextLevel()" class="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-500 text-white font-bold rounded-xl shadow-lg hover:shadow-xl hover:scale-105 transition-all">
                ä¸‹ä¸€ä½é¡¾å®¢ â”
            </button>
        </div>
    </div>

    <script>
        const LEVELS = [
            {
                type: 'scan',
                items: [ {icon:'ğŸ', p:2}, {icon:'ğŸ', p:2}, {icon:'ğŸŒ', p:3} ],
                msg: "ä½ å¥½ï¼ä¹°å‡ ä¸ªæ°´æœã€‚",
                hint: "2 + 2 + 3 = ?"
            },
            {
                type: 'scan',
                items: [ {icon:'ğŸ¥›', p:5}, {icon:'ğŸ', p:4}, {icon:'ğŸ¥š', p:1}, {icon:'ğŸ¥š', p:1} ],
                msg: "åšæ—©é¤éœ€è¦è¿™äº›ã€‚",
                hint: "æ‰«æå•†å“è¿›è¡Œç´¯åŠ "
            },
            {
                type: 'change', // æ‰¾é›¶å…³å¡
                total: 8,
                paid: 10,
                msg: "ä¸€å…±8å…ƒï¼Œç»™ä½ 10å…ƒç°é‡‘ã€‚",
                hint: "10 - 8 = ?"
            },
            {
                type: 'change',
                total: 17,
                paid: 20,
                msg: "è¿™æ˜¯20å…ƒï¼Œä¸ç”¨æ‰¾...å“¦ä¸å¯¹ï¼Œè¿˜æ˜¯è¦æ‰¾é›¶çš„ã€‚",
                hint: "20 - 17 = ?"
            },
            {
                type: 'change',
                total: 36,
                paid: 50,
                msg: "ä¹°äº†å¥½å¤šä¸œè¥¿ï¼Œç»™æ‚¨50å…ƒã€‚",
                hint: "50 - 36 = ?"
            },
            {
                type: 'scan_pain', // ç—›è‹¦åŠ æ³•å…³å¡ (ä¹˜æ³•å¼•å­)
                items: Array(12).fill({icon:'ğŸ¥«', p:3}),
                msg: "åº—é•¿ï¼æˆ‘ä»¬è¦è¿›è´§ï¼Œè¯·æ ¸å¯¹è¿™ 12 ç½çŒ«ç½å¤´ï¼",
                hint: "ä¸€ä¸ªä¸€ä¸ªæ‰«...å¥½ç´¯å•Š..."
            }
        ];

        let curLvlIdx = 0;
        let state = {
            scannedCount: 0,
            currentTotal: 0,
            userInput: '',
            isChangeMode: false
        };

        const ui = {
            itemsArea: document.getElementById('items-area'),
            screenMain: document.getElementById('screen-main'),
            screenSub: document.getElementById('screen-sub'),
            screenContainer: document.getElementById('screen-container'),
            receiptList: document.getElementById('receipt-list'),
            receiptTotal: document.getElementById('receipt-total'),
            receiptId: document.getElementById('receipt-id'),
            btnTotal: document.getElementById('btn-total'),
            modeScan: document.getElementById('mode-scan'),
            modeChange: document.getElementById('mode-change'),
            cashArea: document.getElementById('cash-area'),
            cashDisplay: document.getElementById('cash-display'),
            changeTotal: document.getElementById('change-total'),
            changePaid: document.getElementById('change-paid'),
            modal: document.getElementById('modal'),
            modalBox: document.getElementById('modal-box'),
            modalMsg: document.getElementById('modal-msg'),
            custMsg: document.getElementById('customer-msg'),
            custName: document.getElementById('customer-name'),
            painCounter: document.getElementById('pain-counter')
        };

        function initLevel() {
            const lvl = LEVELS[curLvlIdx];
            state = { scannedCount: 0, currentTotal: 0, userInput: '', isChangeMode: false };
            
            // UI Reset
            ui.itemsArea.innerHTML = '';
            ui.receiptList.innerHTML = '';
            ui.receiptTotal.innerText = '$0';
            ui.screenMain.innerText = '0';
            ui.screenMain.classList.remove('text-red-500');
            ui.screenSub.innerText = 'Ready';
            ui.modal.classList.add('hidden', 'opacity-0');
            ui.receiptId.innerText = `#00${curLvlIdx + 1}`;
            
            ui.custName.innerText = `Customer #${curLvlIdx + 1}`;
            ui.custMsg.innerText = lvl.msg;
            
            ui.painCounter.classList.add('hidden');

            if (lvl.type === 'change') {
                setupChangeMode(lvl);
            } else {
                setupScanMode(lvl);
            }
        }

        // --- æ‰«ææ¨¡å¼ (åŠ æ³•) ---
        function setupScanMode(lvl) {
            ui.modeScan.classList.remove('hidden');
            ui.modeChange.classList.add('hidden');
            ui.cashArea.classList.add('hidden');
            ui.btnTotal.disabled = true;
            ui.btnTotal.innerText = "æ”¶æ¬¾";
            ui.btnTotal.classList.remove('bg-pink-500');
            ui.btnTotal.classList.add('bg-emerald-500');

            if (lvl.type === 'scan_pain') {
                ui.painCounter.classList.remove('hidden');
                updatePainCounter(0, lvl.items.length);
            }

            lvl.items.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = 'text-5xl cursor-pointer hover:scale-110 transition duration-200 relative p-2 select-none active:scale-90';
                el.innerHTML = item.icon;
                el.id = `item-${idx}`;
                
                const tag = document.createElement('span');
                tag.className = 'absolute -bottom-2 right-0 bg-white text-xs font-bold px-1 rounded shadow text-slate-800 pointer-events-none';
                tag.innerText = '$' + item.p;
                el.appendChild(tag);
                
                el.onclick = () => scanItem(idx, item.p, item.icon);
                ui.itemsArea.appendChild(el);
            });
        }

        function updatePainCounter(curr, total) {
            ui.painCounter.innerText = `${curr} / ${total}`;
            if (curr === total) {
                ui.painCounter.classList.add('bg-green-100', 'text-green-600');
                ui.painCounter.classList.remove('bg-pink-100', 'text-pink-600');
            }
        }

        function scanItem(idx, price, icon) {
            const el = document.getElementById(`item-${idx}`);
            if (el.classList.contains('opacity-20')) return; // Already scanned

            // Visual
            el.classList.add('opacity-20', 'grayscale', 'scale-90');
            const line = document.createElement('div');
            line.className = 'scan-line';
            el.appendChild(line);
            el.classList.add('scanning');

            // Logic
            state.scannedCount++;
            state.currentTotal += price;
            
            const lvl = LEVELS[curLvlIdx];
            if (lvl.type === 'scan_pain') {
                updatePainCounter(state.scannedCount, lvl.items.length);
            }

            // Screen Update
            ui.screenSub.innerText = `${ui.screenMain.innerText} + ${price}`;
            ui.screenMain.innerText = state.currentTotal;

            // Receipt Update
            const row = document.createElement('div');
            row.className = 'flex justify-between animate-fade-in';
            row.innerHTML = `<span>${icon} Item</span><span>$${price}</span>`;
            ui.receiptList.appendChild(row);
            ui.receiptList.scrollTop = ui.receiptList.scrollHeight;

            // Check completion
            if (state.scannedCount === lvl.items.length) {
                ui.btnTotal.disabled = false;
                ui.screenSub.innerText = "All items scanned";
                ui.receiptTotal.innerText = '$' + state.currentTotal;
                
                // Visual feedback on button
                ui.btnTotal.classList.remove('bg-emerald-500');
                ui.btnTotal.classList.add('bg-pink-500', 'animate-pulse');
            }
        }

        window.triggerScan = function() {
            const lvl = LEVELS[curLvlIdx];
            if (lvl.type === 'change') return;
            // Find first unscanned
            for(let i=0; i<lvl.items.length; i++) {
                const el = document.getElementById(`item-${i}`);
                if (!el.classList.contains('opacity-20')) {
                    scanItem(i, lvl.items[i].p, lvl.items[i].icon);
                    break;
                }
            }
        }

        window.finishScanning = function() {
            const lvl = LEVELS[curLvlIdx];
            if (lvl.type === 'scan_pain') {
                 showSuccess("å‘¼...æ‰‹å¥½é…¸...å¦‚æœæœ‰ä¹˜æ³•å°±å¥½äº†ï¼(åŠ æ³• x é‡å¤)");
            } else {
                 showSuccess("æ€»ä»·è®¡ç®—æ­£ç¡®ï¼");
            }
        }


        // --- æ‰¾é›¶æ¨¡å¼ (å‡æ³•) ---
        function setupChangeMode(lvl) {
            state.isChangeMode = true;
            ui.modeScan.classList.add('hidden');
            ui.modeChange.classList.remove('hidden');
            ui.cashArea.classList.remove('hidden');
            
            ui.itemsArea.innerHTML = '<div class="text-slate-400 text-sm mt-20 flex flex-col items-center"><span class="text-4xl mb-2">ğŸ›ï¸</span><span>å•†å“å·²æ‰“åŒ…</span></div>';
            
            ui.changeTotal.innerText = '$' + lvl.total;
            ui.changePaid.innerText = '$' + lvl.paid;
            
            // Re-trigger animation
            ui.cashDisplay.classList.remove('cash-fly');
            void ui.cashDisplay.offsetWidth; // Force reflow
            ui.cashDisplay.innerText = '$' + lvl.paid;
            ui.cashDisplay.classList.add('cash-fly');

            ui.screenMain.innerText = '0';
            ui.screenSub.innerText = `${lvl.paid} - ${lvl.total} = ?`;
        }

        window.inputNum = function(n) {
            if (n === 'C') {
                state.userInput = '';
            } else {
                if (state.userInput.length < 4) {
                    state.userInput += n;
                }
            }
            ui.screenMain.innerText = state.userInput || '0';
            ui.screenMain.classList.remove('text-red-500');
        }

        window.submitChange = function() {
            const lvl = LEVELS[curLvlIdx];
            const correct = lvl.paid - lvl.total;
            
            if (state.userInput === '') return;

            if (parseInt(state.userInput) === correct) {
                showSuccess("æ‰¾é›¶æ­£ç¡®ï¼");
            } else {
                // Shake effect
                ui.screenContainer.classList.remove('shake');
                void ui.screenContainer.offsetWidth;
                ui.screenContainer.classList.add('shake');
                
                ui.screenMain.classList.add('text-red-500');
                ui.screenSub.innerText = "Wrong! Try again.";
                setTimeout(() => ui.screenMain.classList.remove('text-red-500'), 500);
                state.userInput = '';
                ui.screenMain.innerText = '0';
            }
        }


        // --- é€šç”¨ ---
        function showSuccess(msg) {
            ui.modalMsg.innerText = msg;
            ui.modal.classList.remove('hidden');
            // Fade in
            requestAnimationFrame(() => {
                ui.modal.classList.remove('opacity-0');
                ui.modalBox.classList.remove('scale-90');
                ui.modalBox.classList.add('scale-100');
            });
        }

        window.nextLevel = function() {
            curLvlIdx++;
            if (curLvlIdx >= LEVELS.length) {
                if (confirm("å¤ªç´¯äº†ï¼12ä¸ªç½å¤´è¦æŒ‰12æ¬¡åŠ æ³•...\n\næœ‰æ²¡æœ‰ä¸€ç§é­”æ³•ï¼Œå¯ä»¥æŠŠâ€œåŠ æ³•â€å˜æˆâ€œæ‰¹é‡æ“ä½œâ€ï¼Ÿ\n\nå‰å¾€ [å†å² 1ï¼šä¹˜æ³•ä¸é™¤æ³•] å¯»æ‰¾ç­”æ¡ˆï¼Ÿ")) {
                    window.location.href = "math_c3.html";
                }
            } else {
                initLevel();
            }
        }

        // Init
        initLevel();

    </script>
</body>
</html>